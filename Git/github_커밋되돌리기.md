# Github 사용법 - 원격 저장소에 올라간 commit 되돌리기
```
210806 TIL #4
```
## ✔️commit을 왜 되돌려?
git으로 버전 관리를 하며 개발하다보면, 작성한 커밋과 푸시 내용이 잘못되어서 이전 상태로 되돌려야 하는 경우가 종종 발생한다.

로컬에서 commit만 한 경우엔 쉽게 `$ git reset` 기능으로 처리할 수 있지만 원격 저장소까지 push된 경우에는 조금 생각해봐야 한다.

> 우선 나 같은 경우 마크다운 파일에서 gist 코드 내장이 가능한지를 확인하기 위해 커밋, 푸시를 했다가 결과를 확인 후 커밋을 되돌리고 싶었다. 

![commit_log](https://user-images.githubusercontent.com/78305431/128474243-02db2575-29e1-4c57-a640-4e81bb1cfea2.png)

위와 같이 두 개의 commit을 push까지 한 상와이고 이를 되돌리려는 상황이다.
***
## ✔️커밋 이력 되돌리기 (로컬저장소)
단순히 로컬 저장소에 커밋(commit)만 상황이라면 간단히 해결이 가능하다.
- `git reset <되돌릴 커밋>` : 현재 작업중인 브랜치의 HEAD 포인터를 과거의 특정 시점을 가르키도록 되돌린다. 이 때 변경된 파일들을 스테이지 영역에 보존시킬 수 도 있고 아예 지워버릴 수도 있다.

![commit_log](https://user-images.githubusercontent.com/78305431/128476503-3e38dea8-c840-42ac-9b02-ba2cf43aadde.png)

:point_right: 이러한 커밋 이력이 있다고 했을 때 각 명령어에 따라 어떻게 바뀌는지를 그림으로 설명할 것이다. 

## ❓ reset 유형
### 1. **reset --soft**

커밋으로 인해 발생한 변경 사항을 제거하지 않고 과거의 커밋으로 HEAD 포인터를 이동시킨다. 커밋 이력은 삭제하더라도 작업했던 변경 내역은 유지하고자 할 때 유용하다.

즉, 이력은 되돌리더라도 추가된 파일은 삭제되지 않기를 원할 때 사용할 수 있다.

![reset_soft](https://user-images.githubusercontent.com/78305431/128477266-b7bc22b3-59bc-4719-86a9-a403354c4777.png)

 :point_right: `git status` 명령으로 확인해 보면 이전 커밋으로 발생한 변경사항에 여전히 접근 가능함을 확인할 수 있다. 이 파일들에 추가 수정사항을 반영하고 새로운 커밋으로 깃허브에 등록이 가능하다.

### 2. **reset --hard**

커밋으로 인해 발생한 모든 수정사항을 지워버린다. 커밋의 변경사항을 유지할 필요가 없을 경우 사용한다. 

즉, 현재의 작업 디렉토리와 스테이지 영역을 완벽하게 과거 커밋 상태로 돌아고싶을 때 사용한다.

![reset_hard](https://user-images.githubusercontent.com/78305431/128477546-d0538ae9-5338-497b-a175-8fba6116d226.png)

***
- `git revert <원복할 커밋>` : 이전 커밋 이력을 삭제하는 대신에 과거 커밋으로 발생한 변경사항을 되돌리는 **새로운 커밋을 생성**한다.

![revert](https://user-images.githubusercontent.com/78305431/128478625-c323d6e2-17c5-4b79-954d-5d223a3a2d7c.png)

:point_right: 브랜치의 커밋 히스토리를 수정하지 않으면서 특정 커밋의 변경사항을 되돌리는 작업에 유용하다.

***

## ❓ reset VS revert
- `reset` 명령은 커밋 히스토리를 수정하므로 작업 이력을 단순하게 만들어 준다. 그러나 이미 원격 저장소에 push된 커밋 이력은 reset으로 되돌리면 안된다. 원격 저장소와 싱크가 맞지 않아 수정된 커밋을 푸시할 수 없다.

- `revert` 명령은 커밋 히스토리를 수정하지 않고 새로운 커밋을 생성하기 때문에 원격 저장소에 푸시 된 커밋도 수정이 가능하다. 과거의 이력이 온전히 보관된다는 점에서 공동 작업 시 유용하다.

***

## ✔️커밋 이력 되돌리기(원격저장소) 
### 1. **reset** 명령어 사용하기 (개인작업)
`$ git reset --hard HEAD~2`

먼저 로컬에서 `reset` 명령어를 이용해 되돌리고 싶은 커밋들(최근 커밋 2개)을 되돌린다.

`$ git push origin`

이후 `push`를 진행한다면 위에서 말했다 싶이 원격 저장소와 싱크가 맞지 않아 에러가 발생한다. 로컬 저장소의 커밋 히스토리가 원격 저장소의 커밋 히스토리보다 뒤쳐져 있는데 푸시를 하였으므로 발생하는 에러이다. 그렇기 때문에 강제로 덮어쓰는 것이 필요하다.

`$ git push -f origin`

-f (--force) 옵션을 추가한다.

## ❓ 주의사항
1번의 방법은 팀원과 협업하는 경우에 사용하기에는 부적합하다. 만약 내가 커밋을 되돌리기 전에 팀원이 작성한 커밋을 이미 pull로 땡겨갔다면, 이를 모르는 팀원이 다시 push할 경우, 내가 되돌렸던 커밋들이 다시 원격 저장소에 추가되게 되기 때문이다.

따라서 이 방법은 해당 경우에서만 안전하게 사용 가능하다.
- 혼자만 사용하는 브랜치인 경우
- 팀원들이 pull하지 않은 경우
***
### 2. **revert** 명령어 사용하기 (공동작업)
`$ git revert [되돌리고 싶은 commit과 hash]` 

특정 커밋에서의 변경 사항을 제거하는 또 다른 커밋을 생성한다. 커밋이 A->B->C 순서로 히스토리가 쌓아 있다면 revert는 C->B->A 순서대로 진행해야 한다. 실행취소로 생각하면 쉽다.

## ❓ 주의사항
revert는 새로운 커밋을 생성하는 방법이다 보니 커밋 로그에서 불필요한 revert 커밋이 생겨난다. 즉, 되돌리고 싶은 커밋이 100개라면 100개의 revert 커밋을 추가해야 한다.

`--no-commit` 옵션을 이용하면, revert 커밋을 하나만 생성할 수 있다.

`$ git revert --no-commit [되돌리고 싶은 commit과 hash]` 을 실행하면 revert 커밋이 자동으로 생성되는게 아니라 working tree와 index(staging area)에만 변경 사항이 적용된다. 

:point_right: 그러나 이 방법도 일일히 revert할 커밋의 수만큼 명령어를 반복해서 실행해야 한다. 그러므로 인수로 입력하는 방법을 사용하자. `$ git revert --no-commit HEAD~3.. `

마지막으로 index에 올라간 변경들은 한꺼번에 커밋한 다음, 원격 저장소에 푸시하면 된다.

`$ git commit -m 'revert'`

`$ git push origin`
***
참고
- https://gitabout.com/8
- https://jupiny.com/2019/03/19/revert-commits-in-remote-repository/